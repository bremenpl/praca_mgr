\subsection{Płytka główna sterownika}
\label{ss:mainboard}

Czwarta opisywana płytka drukowana cechuje się znacznie większym stopniem komplikacji i gęstości ułożenia elementów. Najważniejsze dane liczbowe płytki:

\begin{easylist}
	& wymiary: 109.1 x 25.6 mm,
	& końcowa grubość laminatu: 1.55 mm,
	& ilość warstw: 4,
	& ilość przelotek: 411,
	& liczba komponentów na warstwie górnej: 145,
	& liczba komponentów na warstwie dolnej: 34.
	\\
\end{easylist} 

Kształt i rozmiar PCB został wybrany tak, aby wykorzystać maksymalnie całą dostępną przestrzeń w obudowie głowicy. Rysunek \ref{grafiki/plytka_glowna_foto.jpg} prezentuję poglądowe zdjęcie płytki niezamontowanej w urządzeniu. 

\insertImgSetSize{grafiki/plytka_glowna_foto.jpg}
	{45}
	{Zdjęcie głównej płytki sterującej głowicy układającej (warstwa górna)}
	{oprWlasne}

Dwie wewnętrzne warstwy płytki to tzw. {\it Plane Layers} i służą głównie do doprowadzania zasilania. Na warstwie górnej ({\it Component layer}) jest ułożonych ok. 80\% komponentów. Pozostałe znajdują się na warstwie dolnej ({\it Solder side}). W momencie kiedy wszystkie komponenty elektroniczne znajdują się tylko po jednej stronie płytki, znacząco upraszcza się jej technologia produkcji. W tym wypadku, aby zmontować płytkę przy pomocy automatu typu Pick and Place, należy po za pastą lutowniczą użyć też kleju (dozowanego np. z dyspensera) aby przykleić komponenty po jednej stronie płytki. Dzięki temu kiedy ta trafi do pieca rozpływowego w celu zlutowania, elementy po dolnej stronie nie pospadają. Taka forma projektowania ma jeszcze jedną zaletę- można użyć jednej z warstw tylko do prowadzenia ścieżek, które inaczej było by trudno doprowadzić w niektóre miejsca. W tym wypadku jednak trzeba było pójść na kompromis; ścieżki (prowadzone lokalnie ,,na krzyż'') i komponenty musiały się znaleźć po obu stronach. Ścieżki sygnałowe nie są prowadzone na wewnętrznych warstwach, aby uniknąć pojemności które mogły by się pojawiać pomiędzy nimi.   \\

Zastosowanie lementów THD (przewlekane- {\it Through Hole Device}) zostało ograniczone do minimum w celu optymalizacji czasu montażu. Są to:

\begin{easylist}
	& złącze łączące płytkę główną z płytką enkodera magnetycznego (sekcja \ref{ss:encmag}),
	& złącze programatora (rys. \ref{grafiki/pcb_mcu.png}), 
	& czujnik podciśnienia (sekcja \ref{sss:pressure_sensor}).
	\\
\end{easylist}

Na górnej warstwie pomiędzy złączami znajduje się dużo wolnej przestrzeni na której nie ma umiejscowionych żadnych komponentów. Jest to obszar rozbiegowy dla elastycznej tasiemki łączącej PCB z płytką zasilania (sekcja \ref{ss:power_board} i rysunek \ref{grafiki/glowica.png} c)).

\insertImgSetSize{grafiki/plytka_glowna_warstwy.png}
	{155}
	{Poszczególne warstwy płytki głównej sterownika, od lewej górna, dolna, warstwa zasilania ({\it power plane}), warstwa masy ({\it ground plane})}
	{mechsyspcb}

W następnych sekcjach tego rozdziału zostaną szczegółowo opisane poszczególne moduły elektroniczne płytki głównej. Zostaną zaprezentowane tylko części schematów niezbędne do opisu poszczególnych funkcjonalności. Kompletny schemat płytki znajduję się w załączniku \ref{dac zalacznik}. \\
	
Struktura schematu ideowego ma charakter obiektowy- podobnie jak w programowaniu wysokopoziomowym, zdeklarowane są klasy i tworzone są ich egzemplarze. Pozwala to na separację modułów niskiego poziomu i powielanie ich w prosty sposób tylko na PCB, co przyspiesza projektowanie i zwiększa czytelność schematów.

\insertImgSetSize{grafiki/top_level.pdf}
	{115}
	{Schemat ideowy najwyższego poziomu łączący ze sobą poszczególne moduły w projekcie płytki, w programie Altium Designer}
	{mechsyspcb}

\subsubsection{Zasilanie}

W układzie sterownika potrzebne jest wiele poziomów napięć ze względu na różnorodność zastosowanych układów scalonych. Aby je wszystkie uzyskać zostały zastosowane różne rozwiązania, zarówno bazujące na regulatorach impulsowych jak i liniowych. Wszystkie tory napięciowe są poprowadzone na jednej z warstw wewnętrznych PCB. \\

Do głowicy jest doprowadzone tylko jedno napięcie, z którego uzyskiwane są pozostałe, niższe poziomy. To napięcie 24 V  jest także używane do zasilania uzwojeń obu silników. ,,Logika'' urządzenia jest na poziomie 3.3 V i z tego względu większość elementów na płytce zasilana jest właśnie tym napięciem. Część układów natomiast wymaga do działania napięcia 5 V. W celu efektywnego uzyskania obu napięć został użyty obwód z rys. \ref{grafiki/power_5v_3v.pdf}.

\insertImgSetSize{grafiki/power_5v_3v.pdf}
	{52}
	{Część schematu zasilania prezentująca sposób uzyskania napięć 5 i 3.3V na płytce sterownika}
	{mechsyspcb}

W pierwszej kolejności napięcie główne trafia na przetwornicę A8498 (Allegro Microsystems) typu {\it Buck-converter}, która redukuje je do 5V na wyjściu. Układ jest w stanie dostarczyć prąd o wartości 3A, ale ze względu na niewielką przestrzeń dostępna na płytce elementy mocy przetwornicy (Cewka L1 i dioda D6) zostały dobrane tak, aby być w stanie dostarczyć tylko 400 mA prądu. Natężenie to jest w zupełności wystarczające do zasilania układów logicznych i analogowych sterownika, także tych pracujących przy napięciu 3.3 V-- do wyjścia przetwornicy podłączony jest liniowy stabilizator napięcia LM3940 (Texas Instruments).

\insertImgSetSize{grafiki/power_12_25.pdf}
	{60}
	{Źródła napięcia odniesienia dla obwodu analogowego sterownika}
	{mechsyspcb}
	
Urządzenia LM4040 i LM4041 (rys. \ref{grafiki/power_12_25.pdf}) to diody zenera pracujące jako precyzyjne układy napięcia odniesienia, których napięcie wyjściowe jest odporne na wpływ zmian temperatury otoczenia. Są używane do zasilania układów analogowych stosowanych w obwodzie sterowania silnikami. Więcej na ten temat jest zawarte w sekcji \ref{sss:sterowanie_silnikami}. Ostatnie napięcie to 12V, które jest także uzyskiwane z przetwornicy A8498, w nieco zmienionej konfiguracji (rys. \ref{grafiki/power_12v.pdf}). \\

Zmianie względem poprzedniego obwodu z tą przetwornicą uległy wartości rezystorów tworzących dzielnik napięcia między wyjściem przetwornicy a jej wejściem FB ({\it Feedback}), oraz połączenie do wejścia VBIAS, którego na tym schemacie już nie ma. Rezystory R9/ R11 na schemacie \ref{grafiki/power_12v.pdf} i R1/ R3 na schemacie \ref{grafiki/power_5v_3v.pdf} ustalają wartość napięcia wyjściowego głowicy. Zwierając VBIAS do wyjścia można zasilić układ logiczny w środku A8498. Wtedy wewnętrzny układ zasilający logikę może być wyłączony i chip wydziela mniej ciepła. Niestety można tak zrobić tylko do napięcia 5 V. 

\insertImgSetSize{grafiki/power_12v.pdf}
	{60}
	{Przetwornica typu Buck-converter dająca na wyjściu 12V, zasilająca sterowniki typu {\it High-Side}}
	{mechsyspcb}

Napięcie wyjściowe przetwornicy jest potrzebne do zasilania bramek górnych tranzystorów tworzących mostki H w obwodach silników (sekcja \ref{sss:sterowanie_silnikami}). Wartość tego napięcia może wynosić od 10 do 20 V, gdyż jest to wartość $ V_{GS} $ (napięcie między bramką a źródłem) zastosowanych tranzystorów mocy. Przyłożenie powyżej 20 V do bramki tranzystora może spowodować jego uszkodzenie.  \\

Użycie liniowego stabilizatora napięcia zamiast obwodu z rys. \ref{grafiki/power_12v.pdf}, dającego na wyjściu poniżej 20 V spowodowało by zaoszczędzenie dużej ilości miejsca na płytce. W zamian jednak wydzielała by się na nim duża moc, przez co generowałby więcej ciepła:

\begin{equation} \label{eq:zasilanie1}
	P = (V_{we} - V_{out})I
\end{equation}

Rys. \ref{grafiki/pcb_zasilanie.png} prezentuje model 3D części płytki na której widać oba omówione obwody zasilania. Aby maksymalnie wykorzystać dostępną przestrzeń na PCB, moduły zostały między sobą przedzielone obwodem sterowania silnikami.

\insertImgSetSize{grafiki/pcb_zasilanie.png}
	{36}
	{Rozmieszczenie modułów zasilania na płytce głównej, A: obwód \ref{grafiki/power_12v.pdf}, B: obwód \ref{grafiki/power_5v_3v.pdf}}
	{mechsyspcb}
	
\subsubsection{Jednostka centralna}

Głównym elementem sterującym peryferiami w urządzeniu jest 32 bitowy mikrokontroler STM32407VGT6 z rodziny Cortex® M4 (rodzina ARM) produkowany przez firmę ST Microelectronics. Kluczowymi parametrami decydującymi o doborze układu sterującego były:

\begin{easylist}
	& częstotliwość taktowania,
	& posiadanie jednostki zmiennoprzecinkowej ({\it FPU}- Floating Point Unit),
	& peryferia wewnętrzne pozwalające na sterowanie dwoma silnikami krokowymi (najwięcej końcówek mocy),
	& cena.
	\\
\end{easylist} 

Używając wspomnianego mikrokontrolera udało się zaimplementować wszystkie dotychczasowo działające funkcjonalności i na razie nie są znane żadne przeciwwskazania, które mogłyby by się pojawić w przyszłości. Nie było to jednak prostym zadaniem- urządzenie jest typowym procesorem ,,ogólnego użytku'' i nie posiada zaawansowanych peryferiów tak bardzo przydatnych przy sterowaniu silnikami, jak procesory ku temu dedykowane. 

\insertTab{|c|c|c|}
{%
\hline Mikrokontroler & STM32F407VGT6 & TMS320F28377S  \\
\hline Rodzina & ARM & C28x/ CLA    \\
\hline Architektura & RISC\footnote{{\it Reduced instruction set computing}} & RISC \\
\hline FPU & Single point & Single point \\
\hline \makecell{Maksymalna \\ częstotliwość \\ taktowania} & 168 Mhz & 200 Mhz \\
\hline MIPS \footnote{{\it Million Instructions Per Second}} & 210 & 400 \\
\hline \makecell{Pamięć \\ flash} & 1 MB & 1 MB \\
\hline \makecell{Pamięć \\ RAM} & 194 KB & 164 KB \\
\hline Ilość rdzeni &  1 &  2 \footnote{1 główny + {\it ,,control co-processor''} do obsługi procedur sterowania}  \\
\hline Cena \footnote{Przy zamówieniu 100 sztuk w hurtowni Digi-key} & \$ 9.34 & \$ 22.15 \\
\hline
}
{Porównanie mikrokontrolerów STM32F407VGT6 (ST Microelectronics) i TMS320F28377S  (Texas Instruments)}
{oprWlasne}
{tab:mcu_porownanie}

\insertImgSetSize{grafiki/stm32f407vgt6.png}
	{45}
	{Mikrokontroler STM32F407VGT6 w obudowie TQFP100 o wymiarach 14 x 14 mm}
	{xiawu}

	
W dalszej części tego rozdziału zostały opisane w szczegółach sposoby w jaki poradzono sobie z ograniczeniami mikrokontrolera. W tabeli \ref{tab:mcu_porownanie} przedstawiono porównanie zastosowanego układu z mikrokontrolerem dedykowanym pod sterowanie silnikami. Mimo gorszych parametrów, STM ma jedną ważną zaletę, przez którą zadecydowano o jego wyborze-- Jego współczynnik ceny do możliwości jakie posiada jest bardzo wysoki. Ponadto jest łatwo dostępny. Jest to spowodowane tym że na jego bazie powstała płytka ewaluacyjna {\it STM32-DISCOVERY}, która cieszy się bardzo wysoką popularnością wśród hobbystów i profesjonalistów. 

\insertImgSetSize{grafiki/pcb_mcu.png}
	{65}
	{Widok 3D mikrokontrolera sterującego i otaczających go komponentów}
	{mechsyspcb}

Układy STM32 są bardzo proste w programowaniu i debugowaniu dzięki dostępnym interfejsom {\it JTAG} i {\it SWD} (złącze CON3 na rys. \ref{grafiki/pcb_mcu.png}). JTAG jest interfejsem szybszym i bardziej stabilnym od SWD, ale wymaga większej ilości połączeń. W tym projekcie nie mógł zostać zastosowany gdyż część z pinów, które są potrzebne do jego pracy została użyta przy innych modułach. Źródłem zegarowym dla układu jest zewnętrzny mikro oscylator (Y1) o częstotliwości 16 Mhz. Używając wewnętrznych pętli PLL ({\it Phase Locked Loop}) uzyskiwana jest główna częstotliwość taktowania procesora 168 Mhz. Rysunek \ref{grafiki/clock_pll.png} przedstawia konfigurację wewnętrznych zegarów w mikrokontrolerze. Szybkie działanie mikrokontrolera jest parametrem kluczowym dla konstruowanego sterownika ze względu na to że silniki są maszynami wymagającymi obsługi w czasie rzeczywistym.

\insertImgSetSize{grafiki/clock_pll.png}
	{65}
	{Konfiguracja pętli PLL dla częstotliwości maksymalnej 168 Mhz}
	{oprWlasne}

W celu zapewnienia filtracji zakłóceń na liniach zasilania powodowanych głównie pracą silników, każde z wejść zasilających mikrokontrolera jest odprzęgnięte poprzez kondensator 100 nF (w obudowach 0402 tak jak większość komponentów pasywnych na płytce). \\

Dodatkowo na rysunku \ref{grafiki/pcb_mcu.png} widać złącza CON4 (z lewej) i CON7 (na dole), które łączą płytkę główną kolejno z enkoderem magnetycznym (\ref{ss:encmag}) i optycznym (\ref{ss:encopt}). Połączenie z tym drugim jest zrealizowane tasiemką tego samego typu co doprowadzane jest zasilanie do głównej PCB.

\subsubsection{Komunikacja}
\label{sss:hardware_komunikacja}

Do urządzenia poprzez gniazdo w płytce zasilającej podłączanych jest razem sześć przewodów (CON6 na schemacie \ref{grafiki/schemat_plytka_zasilajaca.eps}). Cztery z nich służą do komunikacji ze sterownikiem poprzez dwie magistrale szeregowe: CAN ({\it Controller Area Network}) i RS232.

\insertImgSetSize{grafiki/rs232_schemat.pdf}
	{70}
	{Zastosowany w kontrolerze układ MAX331 firmy Maxim, służący do translacji poziomów logicznych RS232 na TTL/ CMOS}
	{mechsyspcb}

W większości aplikacji w celu uzyskania poziomów logicznych odpowiednich dla RS232 (+12/ -12 V) stosowane są tanie układy typu MAX3232 lub MAX232 (oraz ich odpowiedniki). Najmniejsza obudowa w jakiej są produkowane te układy to TSSOP16 (typ. 5 x 4.4 mm). Dla płytki głównej sterownika jest to za dużo, dlatego został zastosowany mniejszy   MAX3311 (rys. \ref{grafiki/rs232_schemat.pdf}) w obudowie UMAX10 o wymiarach 3 x 3 mm. Układ jest trochę droższy od wspominanych układów i mniej dostępny u popularnych dystrybutorów. Ponadto, musi być zasilany z napięcia 5V, a nie z 3.3 V. Wejścia zastosowanego mikrokontrolera jednak są zabezpieczone przed napięciami na tym poziomie (tzw. {\it 5V compatible}). Wyjściowe 3.3 V z mikrokontrolera wystarczy zmiany stanu w układzie (TTL).

\insertImgSetSize{grafiki/pcb_rs232.png}
	{60}
	{Komponenty używane przez moduł RS232 zajmują jedynie ok. $ 20 mm^2 $}
	{mechsyspcb}

Obwód magistrali RS232 pełni w sterowniku rolę drugorzędną. Główną drogą dla komend sterujących jest CAN, którego zaletą jest to że bazując na LVDS ({\it Low-voltage differential signaling}) jest odporny na zakłócenia. W celu zwiększenia impedancji składowej wspólnej od strony sieci został zastosowany dławik (L3 na schemacie \ref{grafiki/can_schemat.pdf}). Ponadto, korzystając z tej magistrali sterownik można podpiąć pod istniejącą sieć, bez potrzeby odłączania pracujących na niej urządzeń.

\insertImgSetSize{grafiki/can_schemat.pdf}
	{40}
	{Moduł CAN korzystający z układu SN65HVD230D (Texas Instruments) w celu translacji sygnałów z magistrali}
	{mechsyspcb}
	
Etykietą $ DIFF_{CAN1} $ (rys. \ref{grafiki/can_schemat.pdf}) oznaczone są linie będące parą różnicową. Daje to możliwość projektując płytkę PCB na prowadzenie ścieżek danej pary w taki sposób, aby miały tą samą, lub bardzo podobną długość.

\insertImgSetSize{grafiki/pcb_can.png}
	{50}
	{Widok 3D na moduł CAN}
	{mechsyspcb}
	
\subsubsection{Czujnik podciśnienia}
\label{sss:pressure_sensor}

Głowica której częścią jest sterownik, do podnoszenia komponentów elektronicznych używa ssawki podciśnieniowej. Możliwość pomiaru wartości aktualnego podciśnienia zapewnia czujnik z serii XFHM firmy Fujikura. 

\insertImgSetSize{grafiki/pcb_czujnik.png}
	{60}
	{Czujnik podciśnienia XFHM-100KPGWRH znajdujący się na płytce głównej}
	{mechsyspcb}

Jest to element, którego gabaryty są największe na opisywanej płytce. Ponadto, w wersji z mocowaniem przewodu pneumatycznego poziomo, występuje tylko w w obudowie przewlekanej. Czujnik jest pneumatycznie sprzężony z aluminiową kostką (rys. \ref{grafiki/pcb3d_plytka_encmag.png} i \ref{grafiki/przekroj_silnik.png}) w której panuje ciśnienie niższe niż atmosferyczne. Jego wartość spada tym bardziej im szczelniej zatkany jest wylot pinoli przez podnoszony komponent. Na wyjściu układu XFHM-100KPGWRH pojawia się potencjał którego amplituda odzwierciedla wartość mierzonego podciśnienia. Dla różnicy ciśnień 0 kPa amplituda wynosi 2.5 V (połowa maksymalnego zakresu, którym jest zapięcie zasilania) i spada do 0 V dla -100 kPa lub rośnie do 5V dla 100 kPa. Dodatnia wartość różnicy ciśnienia w normalnej aplikacji nie występuje, kiedy element jest odkładany zawór zamyka dopływ powietrza i komponent przestaje być zasysany. W niektórych aplikacjach specjalizowanych jednak podnoszone elementy muszą być wydmuchiwane i wtedy mierzona jest dodatkowo wartość dodatnia.

Aby umieścić czujnik w dogodnym miejscu na PCB należało go pozbawić jednego z wyprowadzeń (nr 5) zaznaczonych na rysunku \ref{grafiki/pcb_czujnik.png}. Wewnętrznie ten pin nie jest do niczego podłączony, a z racji tego że jest środkowym pinem w danym rzędzie, to pozbycie się go nie zmniejsza stabilności układu.

\insertImgSetSize{grafiki/upress_sensor.pdf}
	{60}
	{Schemat ideowy obwodu czujnika podciśnienia}
	{mechsyspcb}

Napięcie odniesienia dla przetwornika analogowo-cyfrowego mikrokontrolera sterującego to 2.5 V (rys. \ref{grafiki/power_12_25.pdf}), dlatego na wyjściu z układu U16 na schemacie \ref{grafiki/upress_sensor.pdf} jest dzielnik napięcia zmieniający zakres napięć z 0 - 5 V do 0 - 2.5 V, aby nie wykraczać po za zakres napięć ADC ({\it Analog to Digital Converter}).

\subsubsection{Obwód sterowania silnikami}
\label{sss:sterowanie_silnikami}

W skład modułu sterowania silnikami wchodzą obwody: \\

\begin{easylist}
	& z końcówkami mocy do zasilania danego silnika,
	& do cyklicznego pomiaru prądu płynącego w uzwojeniach,
	& do odcięcia prądu od uzwojeń w przypadku awarii.
	\\
\end{easylist} 
	
Schemat \ref{grafiki/motor_circuit.pdf} prezentuje opisywany moduł używając zdefiniowanych podmodułów HS, HH, CSHS i CSLS. Funckja REPEAT w programie Altium służy do mnożenia obiektów, np. w tym wypadku obwody CSHS są dwa, a CSLS trzy.

\clearpage

\insertImgSetSize{grafiki/motor_circuit.pdf}
	{100}
	{Schemat ideowy modułu MOTCIR ze schematu nadrzędnego \ref{grafiki/top_level.pdf}}
	{mechsyspcb}

\tocLessLeftNorm{HS - Standardowy sterownik pół-mostka}

W urządzeniu jest zastosowanych 5 obwodów HS (\textit{\textbf{H}igh Side with \textbf{S}oftware Deadtime}). Służą do tego aby dostarczać prąd do uzwojeń silników. Pojedynczy moduł HS jest widoczny na schemacie \ref{grafiki/high_side_swdt.pdf}. Na wejścia układu IR2101 (firma International Rectifier) wchodzą komplementarne sygnały PWM z mikrokontrolera sterującego. \\

IR2101 jest układem scalonym służącym do sterowania tranzystorami w półmostku po stronie niskiej i wysokiej. Aby otworzyć górny tranzystor typu N, używane jest napięcie zasilania 12 V z przetwornicy U8 (schemat \ref{grafiki/power_12v.pdf}). Podczas kiedy dolny tranzystor Q1B jest otwarty, Q1A jest zamknięty a kondensator C11 ładowany przez diodę Shotkiego D5. Kiedy następuje zmiana wymuszenia kierunku przepływającego w uzwojeniu prądu Q1B się zamyka, a następnie po odczekaniu ustalonego czasu martwego Q1A może zostać otwarty dzięki dodatkowemu napięciu na kondensatorze C11. Tym sposobem potencjał na bramce górnego tranzystora jest o wyższy o 12 V od potencjału na jego źródle (minus spadek na diodzie D5 i R15)\\
	
IR2101 nie ma zabezpieczenia przed otwarciem dwóch tranzystorów jednocześnie. Czas martwy, który temu zapobiega jest ustawiany w module PWM mikrokontrolera. W celu zapewnienia odpowiedniego kluczowania tranzystorów, w tej aplikacji czas martwy dla wszystkich końcówek mocy został ustawiony na 100 ns.

\insertImgSetSize{grafiki/high_side_swdt.pdf}
	{60}
	{Schemat ideowy modułu HS ({\it High Side driver} z programowym czasem martwym}
	{mechsyspcb}
	
Kondensatory ceramiczne C9 (obudowa 1206) i C14 (2220) zapewniają pojemność, która pomaga utrzymać stabilny poziom napięcia na uzwojeniu przy kolejnych komutacjach. 

\insertImgSetSize{grafiki/IR2101.pdf}
	{70}
	{Schemat funkcjonalny {\it High/ Low side} driver'a IR2101 firmy International Rectifier (obecnie Infineon)}
	{irf}

Rezystory w szeregu z bramkami tranzystorów (R15 i R16) służą do ograniczenia prądów bramek. Ponadto zapewniają ochronę układu scalonego IR2101 w przypadku uszkodzenia jednego z tranzystorów, które może doprowadzić do przebicia izolacji między bramką a drenem i źródłem. \\

Etykieta MOT oznacza miejsce podłączenia jednego z końców uzwojenia, HIS i LOS to wyprowadzenia z obwodów pomiaru prądu po stronie górnej i dolnej. W obwodzie silnika VCM znajdują się dwa moduły HS, natomiast w module krokowego trzy moduły HS i jeden HH.

\tocLessLeftNorm{HH - modyfikowany sterownik pół-mostka}

Przyczyną dla której w urządzeniu został zastosowany jeden moduł HH (\textit{\textbf{H}igh Side with \textbf{H}ardware Deadtime}) i pięć HS, zamiast sześciu HS jest to że sterujący mikrokontroler STM32F407VTG6 nie posiada wystarczającej ilości komplementarnych modułów PWM.

\insertImgSetSize{grafiki/tim18.pdf}
	{130}
	{Schemat blokowy zaawansowanego Timer'a 1 i 8 w mikrokontrolerach STM32F4 firmy ST Microelectronic}
	{st}

Schemat blokowy \ref{grafiki/tim18.pdf} prezentuje architekturę pojedynczego zaawansowanego timer'a w STM32F4. Używany mikroprocesor posiada dwa takie peryferia o numerach 1 i 8. Timer 1 służy do sterowania silnikiem pierwszym (krokowym) a timer 8 drugim (VCM). Jak widać na schemacie, czwarty z kanałów PWM jest uboższy od pozostałych trzech. Nie posiada wyprowadzenia komplementarnego, a co za tym idzie tez modułu czasu martwego przez co urządzenie wymaga zastosowania dodatkowego obwodu, który rozszerza możliwości czwartego kanału. Pomimo tego że timer silnika VCM posiada jeszcze jeden wolny kanał ,,bogaty'', to nie mógł on zostać zastosowany w obwodzie silnika krokowego. Burzyło by to koncepcje uniwersalnego sterownika pod względem programowym, która wymaga aby moduły sterujące silnikami były całkowicie oddzielne. W takim łączonym rozwiązaniu nie było by możliwości między np. zaprogramowania różniej częstotliwości dla każdego silnika. Ponadto, chcąc w przyszłości zastosować obecny kod kontrolera dla nieco odmienionej płytki sterownika, będzie trzeba dokonywać dodatkowych zmian w oprogramowaniu.

\insertImgSetSize{grafiki/high_side_hwdt.pdf}
	{70}
	{Schemat ideowy modułu HH ({\it High Side driver}) ze sprzętowym czasem martwym i kanałem komplementarnym}
	{mechsyspcb}

Aby zapewnić czas martwy i dodatkowy kanał komplementarny na kanale czwartym został zastosowany obwód ze schematu \ref{grafiki/high_side_hwdt.pdf}. Sygnał z etykietą HIN jest opisywanym czwartym kanałem. Aby utworzyć z niego dodatkowy sygnał komplementarny została zastosowana bramka XOR (U6) na której jedno z wejść wchodzi HIN. Na drugie wejście U6 jest doprowadzane wyjście z bramki AND (U7). Jej wejścia to z kolei sygnał odblokowujący moduł (etykieta $ VLIN_{EN} $) i {\it BREAK}, który zmienia stan na niski w przypadku wystąpienia przeciążenia prądowego (rys. \ref{grafiki/cursens_hs.pdf}). 

\insertImgSetSize{grafiki/bramki.png}
	{40}
	{Część PCB w której znajdują się dyskretne bramki U7 i U6 tworzące kanał komplementarny}
	{mechsyspcb}
	
Bramka AND zapewnia możliwość całkowitego wyłączenia danego półmostka, a czas martwy jest generowany w samym sterowniku, który w obwodzie HH został zamieniony z IR2101 na IR25601 tego samego producenta. 

\insertImgSetSize{grafiki/IR25601.pdf}
	{85}
	{Schemat funkcjonalny {\it High/ Low side} driver'a IR25601 firmy International Rectifier (obecnie Infineon)}
	{irf}

Dlatego pomimo tego że na wejścia układu są podawane komplementarne sygnały bez żadnych opóźnień, to same bramki tranzystorów są przełączane z uwzględnieniem 100 ns czasu martwego (wewnętrzne opóźnienie w układzie). 

\insertTab{|c|c|c|c|c|}
{% 
\hline \multicolumn{4}{|c|}{Sygnały i ich stany\footnote{Etykiery sygnałów ze schematu \ref{grafiki/high_side_hwdt.pdf}. Stany: 1 - stan wysoki, 0 - stan niski, X - bez znaczenia przy danym trybie pracy}} & Tryb pracy \\ 
\cline{1-4} HIN & $ VLIN_{EN} $ & BRK & VLIN & \\
\hline 1 & 1 & 1 & 0 & normalna praca, górny tranzystor otwarty \\
\hline 0 & 1 & 1 & 1 & normalna praca, dolny tranzystor otwarty \\
\hline 0 & X & 0 & 0 & przeciążenie prądowe, tranzystory zamknięte \\
\hline 0 & 0 & 1 & 0 & pół-mostek wyłączony \\
\hline
}
{Tabela prawdy prezentująca działanie zaprojektowanego sprzętowego modułu komplementarnego}
{oprWlasne}
{tab:tabela_prawdy}

Obwód w takiej konfiguracji działa bez zarzutu dlatego, że nie wszystkie możliwe stany linii wejściowych są dozwolone. Tabela \ref{tab:tabela_prawdy} prezentuje cztery możliwe tryby w których może znajdować się obwód. Kiedy sygnał BRK zmienia swój stan na niski, wszystkie wyjścia PWM danego modułu w mikrokontrolerze zmieniają swój stan także na niski (zwykłe i komplementarne). To oznacza zamknięcie wszystkich tranzystorów. Dlatego kiedy BRK jest nisko, HIN też musi i stan na linii $ VLIN_{EN} $ nie ma wtedy znaczenia- VLIN i tak będzie w stanie niskim.

\clearpage

\tocLessLeftNorm{CSHS - Bezpiecznik prądu krytycznego}

Moduły zaawansowanych timerów w mikrokontrolerach STM32F4 posiadają konfigurowalne wejścia zabezpieczające ,,BREAK'' (odpowiednio $ TIM1_{BKIN} $ i $ TIM8_{BKIN} $, patrz schemat \ref{grafiki/tim18.pdf}). Dla zastosowanych w sterowniku ustawień, podanie na pin Break stanu niskiego spowoduje wyłączenie końcówek mocy skojarzonego silnika. Urządzenie korzysta z tej funkcjonalności w taki sposób, że kiedy prąd w uzwojeniu przekroczy zadany poziom, silniki przestają działać niezależnie od tego jakie procedury są akurat wykonywane w oprogramowaniu. Jest to zabezpieczenie ostateczne zapobiegające uszkodzeniu uzwojeń silników.

\insertImgSetSize{grafiki/cursens_hs.pdf}
	{75}
	{Schemat ideowy modułu CSHS ({\it Current Sense at High Side}) zabezpieczającego uzwojenia przed przeciążeniem prądowym}
	{mechsyspcb}
	
W celu uzyskania opisywanej funkcjonalności został zastosowany obwód z modułu HSCS (rys. \ref{grafiki/cursens_hs.pdf}). Etykieta DAC to sygnał z przetwornika cyfrowo-analogowego mikrokontrolera sterującego. W taki sposób ustawiany jest zakres na wejściu nieodwracającym komparatora napięcia MCP6561R. Na jego wejście odwracające doprowadzane jest napięcie z wzmacniacza pomiarowego TSC101 (\ref{grafiki/tsc101.pdf}), które odzwierciedla poprzez napięcie wartość płynącego prądu w uzwojeniach danego silnika. Zasada działania układu scalonego TSC101 bazuje na zwierciadle prądowym. Może on być zasilany z napięcia niższego niż te które trafia na jego wejścia. Napięcie na wyprowadzeniu OUT układu można wyliczyć z wzoru:

\begin{equation} \label{eq:mainboard1}
	V_{OUT} = R8 \cdot I_{R8} \cdot G
\end{equation}

Gdzie G to wzmocnienie typowe dla danego modelu TSC101, układ stosowany w sterownika ma końcówkę ,,A'', która oznacza $ G = 20 $.

Kiedy prąd płynący w uzwojeniach danego silnika (i jednocześnie przez rezystor R8) jest wystarczająco wysoki, aby napięcie na wyjściu U12 przekroczyło te zadane przez mikrokontroler poprzez DAC, to wyjście komparatora U3 przechodzi w stan niski uruchamiając zabezpieczenie prądowe. Poprzez wyjście DAC istnieje możliwość ustawienia prądu odłączenia z bardzo wysoką dokładnością (rozdzielczość przetwornika to 12 bitów). Nie ma jednak możliwości pomiaru prądu. Tą funkcjonalność zapewnia moduł CSLS.

\insertImgSetSize{grafiki/tsc101.pdf}
	{100}
	{Schemat funkcjonalny wzmacniacza pomiarowego TSC101 firmy ST Microelectronic}
	{st}

\tocLessLeftNorm{CSHS - Obwód pomiaru prądu}

Każdy z mostków H posiada jeden moduł CSLS (dwa w obwodzie silnika krokowego i jeden w VCM). Moduł służy to cyklicznego pomiaru spadku napięcia na rezystorze pomiarowym znajdującym się w dolnej części mostka. Po przeliczeniu daje to dokładną informację o natężeniu prądu znajdującym się w uzwojeniu, która jest używana w celu programowego zabezpieczenia przed przeciążeniem (zanim zadziała zabezpieczenie krytyczne) i w procedurze regulacji prądu w sterowaniu momentem obrotowym. \\

Rysunek \ref{grafiki/cursens_ls.pdf} przedstawia schemat ideowy obwodu CSLS. Do pomiaru spadku na rezystorze pomiarowym został zastosowany specjalizowany wzmacniacz pomiarowy INA826 firmy Texas Instruments. Do regulacji wzmocnienia używany jest rezystor $ 1 k\Omega $ o dokładności 0.1 \% podłączony do zacisków RG. W prezentowanej aplikacji wzmocnienie wynosi $ G = 50.4 $. Napięcie odniesienia 1.2 V (schemat \ref{grafiki/power_12_25.pdf}) jest używane do ustawienia punktu pracy wzmacniacza ({\it Bias voltage}). W tej konfiguracji napięcie spoczynkowe na wyjściu wzmacniacza wynosi 1.2 V i obniża się (min. 0 V) lub wzrasta (max 3.3 V) w zależności od kierunku przepływu prądu przez rezystor pomiarowy R13. Użyteczny zakres na przetwornika ADC mikrokontrolera to od 0 do 2.5 V (napięcie odniesienia ADC).

\insertImgSetSize{grafiki/cursens_ls.pdf}
	{65}
	{Schemat ideowy modułu CSLS ({\it Current Sense at Low Side}) służącego do pomiaru prądu w uzwojeniach}
	{mechsyspcb}
	
Schematy blokowe \ref{grafiki/mostki_krokowy.pdf} i \ref{grafiki/mostki_vcm.pdf} obrazują konfigurację opisanych modułów w odniesieniu do obwodów obu silników.

\insertImgSetSize{grafiki/mostki_krokowy.pdf}
	{75}
	{Schemat blokowy obwodu silnika krokowego}
	{oprWlasne}
	
Silnik krokowy wymaga pomiaru natężenia prądu w dwóch miejscach ze względu na to że posiada dwa uzwojenia. Bezpiecznik prądu jest wymagany tylko jeden, gdyż liczy się dla niego tylko prąd całkowity, bez względu na to w którym uzwojeniu nastąpiło przeciążenie. 

\insertImgSetSize{grafiki/mostki_vcm.pdf}
	{75}
	{Schemat blokowy obwodu silnika VCM}
	{oprWlasne}

Na rysunku \ref{grafiki/moduly_top.png} widać ułożenie tych z opisywanych modułów, które znajdują się po górnej stronie płytki głównej. Złączami CON1, CON2 i CON5 połączane są kolejno silnik krokowy, silnik VCM i zawór podciśnienia.
	
\insertImgSetSize{grafiki/moduly_top.png}
	{77}
	{Wyszczególnione moduły obwodu silników po stronie górnej PCB}
	{mechsyspcb}
	
Obiekty CSHS nie zmieściły się na górze i zostały przeniesione na dolną warstwę (rys. \ref{grafiki/moduly_bot.png}). W celu uzyskania jak najlepszych, bezzakłóceniowych odczytów spadków napięć na rezystorze pomiarowym, potencjał pomiędzy R13 a R19 (schemat \ref{grafiki/cursens_ls.pdf}) jest odłączony od ,,wylanej'' na dolnej warstwie masy i jest połączony jedynie przelotkami z warstwą środkową (patrz rys. \ref{grafiki/masa_rmeas.png}). Dokładne procedury pomiaru prądu w uzwojeniach i sterowania silnikiem zostały opisane w rozdziale \ref{s:oprogramowanie}. 

\insertImgSetSize{grafiki/moduly_bot.png}
	{77}
	{Wyszczególnione moduły obwodu silników po stronie dolnej PCB}
	{mechsyspcb}

Podsumowując, udało się zbudować kompletny sterownik do dwóch silników działających w pętli ze sprzężeniem zwrotnym używając przy tym bardzo ograniczonej przestrzeni. Nie udało się jednak umieścić wszystkich modułów na jednym PCB i dlatego poszczególne obwody są rozproszone na cztery płytki. Mimo to, złożenie prototypu nie stanowi problemu i jest to czynność powtarzalna.

\insertImgSetSize{grafiki/masa_rmeas.png}
	{60}
	{Zaznaczony niedostępny obszar dla propagacji masy po dolnej stronie PCB}
	{mechsyspcb}


\clearpage














