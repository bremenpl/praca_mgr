\subsection{Procedury sterowania wysokopoziomowego}

Sterowanie wyższego poziomu w kontrolerze polega na manipulacji, czy też operacjach na danych, które nie mają jeszcze bezpośredniego wpływu prąd w uzwojeniach czy pozycję kątową wału silnika. Odzwierciedlają one jedynie różne wielkości, które następnie są przekazywane do niższej warstwy oprogramowania, która ma steruje silnikami (\ref{sss:lowlevel}). \\

Procedury sterowania wysokopoziomowego dla obu rodzajów silników (krokowy i VCM) w większości są identyczne. Odmiennie wyglądają moduły sterowania prądem w uzwojeniach, ze względu na odmienną konstrukcję silników. Rys. \ref{grafiki/pid_vcm.pdf} prezentuje poglądowy diagram sterowania silnika VCM, a rys. \ref{grafiki/pid_stepper.pdf} silnika krokowego.

\clearpage

\insertImgSetSize{grafiki/pid_vcm.pdf}
	{225}
	{Schemat blokowy sterowania wysokopoziomowego silnikiem VCM, zaimplementowanego w kodzie sterownika}
	{oprWlasne}
	
\clearpage
	
\insertImgSetSize{grafiki/pid_stepper.pdf}
	{220}
	{Schemat blokowy sterowania wysokopoziomowego silnikiem krokowym, zaimplementowanego w kodzie sterownika}
	{oprWlasne}
	
\clearpage
	
\subsubsection{Regulatory pozycji i prędkości}
\label{sss:posvelregs}

W celu zapewnienia zadanej pozycji (kątowej w przypadku silnika krokowego i liniowej przy VCM) w sterowniku został zastosowany regulator pozycji typu PID-- proporcjonalno-całkująco-różniczkujący ({\it proportional–integral–derivative}). Jego zasadę działania wyraża wzór \ref{eq:pid1}.

\begin{equation} \label{eq:pid1}
	s(t) = K_p e(t) + K_i \int_0^t e(t)dt + K_d \frac{de(t)}{dt}
\end{equation}

Gdzie:

\begin{easylist}
	& $ s(t) $ : pozycja w danej chwili $ t $ $ [m] $,
	& $ e(t) $ : błąd pozycji $ e(t) = v(t) - v(t - 1) [m] $,
	& $ K_p  $ : współczynnik proporcjonalny $ [m] $,
	& $ K_i  $ : współczynnik całkujący $ [m \cdot s] $,
	& $ K_d  $ : współczynnik różniczkujący $ [\frac{m}{s}] $.
	\\
\end{easylist} 

Implementację algorytmu w kodzie mikrokontrolera przedstawia listing \ref{kody/pid_PosController.c}.

\insertCode{kody/pid_PosController.c}
	{C}
	{Kod regulatora pozycji zaimplementowany w  mikrokontrolerze, wywoływany w interwale $ dt = 0.001 s $}
	{mechsyscode}
	
Funkcja zawiera dodatkowo mechanizm zabezpieczający regulator przed zmagazynowaniem zbyt dużego błędu pozycji, co może spowodować przeregulowanie układu ({\it ,,Anti-Windup''}). Jako parametry wejściowe podawane są aktualna pozycja (odczytana z enkodera) i pozycja zadana. Wyjście regulatora pozycji jest następnie podawane na wejście regulatora prędkości (\ref{grafiki/pid_vcm.pdf}). \\

Regulator prędkości działa w ten sam sposób co regulator pozycji, z tą różnicą że sygnał wyjściowy z regulatora jest wielkością tego samego typu co sygnał wejściowy (w uproszczeniu, bo tylko regulator typu P daje na wyjściu sygnał tej samej wielkości co na wejściu). Suma (lub różnica w zależności od znaku zmiennej zwracanej z funkcji) tych dwóch sygnałów tworzy regulowaną prędkość zadaną. Zastosowanie oddzielnych regulatorów dla pozycji i prędkości pozwala w bardzo precyzyjny sposób konfigurować pracę danego silnika przy pomocy współczynników $ K_p $, $ K_i $ i $ K_d $ ({\it tunning}). Kolejne bloki różnią się w zależności od zastosowanego silnika.

\subsubsection{Sterowanie prędkością kątową silnika krokowego}

W modelu sterowania, który został zaimplementowany w oprogramowaniu kontrolera, parametrami decydującymi o aktualnej prędkości kątowej silnika krokowego są:

\begin{easylist}
	& częstotliwość komutacji,
	& tryb pracy (,,bieg'').
	\\
\end{easylist} 

Wartości wymienionych parametrów są automatycznie obliczane w pętli sterowania dla zadanej prędkości obrotowej. W celu   inicjalizacji algorytmu, należy podać następujące parametry:

\begin{easylist}
	& ilość pełnych kroków na obrót dla danego silnika,
	& ilość biegów (maksymalna dopuszczalna rozdzielczość pracy mikrokrokowej),
	& maksymalna częstotliwość komutacji $ [Hz] $,
	& maksymalna użyteczna prędkość kątowa dla danego silnika $ [RPM] $.
	\\
\end{easylist} 

Relacja między ilością biegów i rozdzielczością przy pracy mikrokrokowej jest następująca:

\begin{equation} \label{eq:pid7}
	gearsNr = \log_2(resolution) + 1
\end{equation}

W pierwszej kolejności algorytm oblicza wartości progowe prędkości obrotowych dla których następuje ,,automatyczna zmiana biegu''. Wartości te są nieco inne dla przypadku w którym silnik jest rozpędzany i hamowany, dzięki czemu bieg nie jest zmieniany zbyt często przy wartościach skrajnych (działanie bazujące na histerezie, podobnie jak w przerzutniku {\it Shmitta}). \\

Dla przypadku rozpędzania wirnika z bezruchu, wirtualna przekładnia rozpoczyna pracę przy największej rozdzielczości mikrokroków. Wraz ze wzrostem prędkości obrotowej częstotliwość komutacji jest zwiększana. Im większa częstotliwość komutacji, tym częściej system musi przerywać pozostałe prace, dlatego maksymalną częstotliwość należy dobrać w taki sposób, aby nie zagłodzić pozostałych procesów w systemie. Po osiągnięciu maksymalnej częstotliwości następuje zmiana biegu, czyli dwukrotne zmniejszenie rozdzielczości mikrokroków. Częstotliwość komutacji także dwukrotnie maleje. Działanie to jest powtarzane aż do osiągnięcia maksymalnej ustalonej prędkości obrotowej (i jednocześnie maksymalnego biegu i częstotliwości komutacji). Algorytm pozwala zoptymalizować pracę silnika poprzez korzystanie z największej rozdzielczości tylko wtedy, kiedy jest potrzebna (rozpędzanie wirnika i precyzyjne hamowanie). Rys. \ref{grafiki/freq_gear_stepper.eps} prezentuje w graficzny sposób działanie układu.

\insertImgSetSize{grafiki/freq_gear_stepper.eps}
	{100}
	{Wizualizacja algorytmu obliczającego częstotliwość komutacji i bieg dla zadanej prędkości obrotowej wału}
	{oprWlasne}
	
Można zauważyć że praca na najwyższym biegu (1 mikrokrok na 1 pełny krok) to tak naprawdę tryb falowy (sekcja \ref{sss:sterowanie_krokowy}, rys. \ref{grafiki/stepper_sterowanie_falowe.eps}). Układ przechodzi do niego w naturalny sposób z trybu mikrokrokowego. W aplikacji takiej jak głowica układająca duży moment obrotowy nie jest wymagany, dlatego nie ma potrzeby implementacji trybu pełnokrokowego na ostatnim biegu. Docelowo jednak, funkcjonalność ta będzie musiała być dodana (np. sterowanie ruchu portalu w osi X i Y).

\subsubsection{Regulator prądu silnika VCM}

Wartość prądu zadanego dla uzwojenia maszyny VCM uzyskuje się poprzez jego estymatę, biorąc pod uwagę właściwości fizyczne układu napędowego (blok {\it VCM CURRENT ESTIMATOR} na schemacie \ref{grafiki/pid_vcm.pdf}). Na wejście estymatora trafia wartość absolutnego (względem obudowy), aktualnego wysuwu cylindra silnika. Zadana wartość wysuwu jest uzyskiwana poprzez pomnożenie stałej czasowej układu przez scałkowaną po czasie prędkość z jaką porusza się cylinder (\ref{eq:pid2}).

\begin{equation} \label{eq:pid2}
	stroke(t) = \int_0^t v(t) dt
\end{equation}

Do obliczenia zadanego prądu dla silnika VCM należy się posłużyć modelem fizycznym z rys. \ref{grafiki/sprezyna_vcm.eps}.

\insertImgSetSize{grafiki/sprezyna_vcm.eps}
	{50}
	{Teoretyczny model układu napędowego modułu z silnikiem VCM}
	{oprWlasne}
	
Obiekt $ A $ reprezentuje część ruchomą głowicy, czyli wszystkie komponenty znajdujące się po stronie cylindra (rys. \ref{grafiki/glowica.png}). $ B $ to część nieruchoma, po stronie której znajduje się obudowa silnika. 

\insertImgSetSize{grafiki/vcm_current.eps}
	{100}
	{Przebieg teoretycznego prądu (oś Y) wymaganego w uzwojeniu do wysuwu cylindra na zadaną odległość (oś X)}
	{oprWlasne}

W pierwszej kolejności należy obliczyć działającą na ciało $ A $ siłę sprężyny $ F_s $ (\ref{eq:pid3}):

\begin{equation} \label{eq:pid3}
	F_s = F_{s0} + R_s \cdot S \quad [ N = N + \frac{N}{m} \cdot m ]
\end{equation}

\begin{easylist}
	& $ F_{s0} $ : siła początkowa sprężyny $ [N] $,
	& $ R_s $ : stała sprężyny $ [\frac{N}{m}] $,
	& $ S $ : wysuw cylindra $ [m] $.
	\\
\end{easylist} 

Następnie należy obliczyć siłę $ F_m $ z jaką oddziałuje na ciało grawitacja (\ref{eq:pid4}):

\begin{equation} \label{eq:pid4}
	F_m = m_A \cdot g \cdot \sin \alpha \quad [ N = kg \cdot \frac{m}{s^2} \cdot 1 ]
\end{equation}

\begin{easylist}
	& $ m_A $ : sumaryczna masa części ruchomej głowicy $ [kg] $,
	& $ g $ : przyspieszenie ziemskie $ [\frac{m}{s^2}] $,
	& $ \alpha $ : kąt ustawienia głowicy względem płaszczyzny (normalnie 90\degree{}) $ [deg] $.
	\\
\end{easylist} 

Potem liczona jest wypadkowa siła $ F $ (\ref{eq:pid5}) działająca na ciało $ A $. Im cięższa jest część ruchoma głowicy, tym bardziej jest wysunięty cylinder w stanie spoczynku (bezprądowym). 

\begin{equation} \label{eq:pid5}
	F = F_s - F_m \quad [ N = N - N ]
\end{equation}

\insertImgSetSize{grafiki/vcm_force.eps}
	{100}
	{Charakterystyka prądowa zastosowanego silnika VCM odtworzona w programie używając charakterystyki z karty katalogowej}
	{oprWlasne}

Ostatnim krokiem jest odczytanie stałej silnika VCM ($ F_c $ -- {\it force constant}) z charakterystyki dostarczonej przez producenta (np. \ref{grafiki/vcm_force_current_plot.eps}) i obliczenie prądu w uzwojeniu dla wymaganego wysuwu cylindra (\ref{eq:pid5}):

\begin{equation} \label{eq:pid6}
	I = \frac{F}{F_c} \quad [ A = \frac{N}{\frac{N}{A}} ]
\end{equation}
	
Na rys. \ref{grafiki/vcm_current.eps} widać wynik symulacji w postaci prądu w funkcji wysuwu cylindra. Obliczenia zostały przeprowadzone przy rzeczywistych wartościach parametrów układu napędowego. Wykres wskazuje na to, że w stanie spoczynku część ruchoma głowicy jest wysunięta na odległość ok. 6.7 mm. Charakterystyka ma charakter liniowy w swojej środkowej części, ze względu na kształt charakterystyki prądowej silnika wprowadzonej do algorytmu jako parametr (\ref{grafiki/vcm_force.eps}). 
Wyznaczony prąd zadany trafia do właściwego regulatora prądu typu PI. jego realizacja różni się od poprzednich regulatorów tym, że nie ma już członu różniczkującego, który w przypadku regulacji prądu nie dał by wielu korzyści. Ponadto stała czasowa pętli prądowej wynosi $ 100 \mu s $. Wartość prądu jest następnie zamieniana na odpowiednie wypełnienie impulsów w uzwojeniu-- więcej informacji na ten temat jest zawarte w sekcji \ref{sss:lowlevel}.

\subsubsection{Regulator prądu silnika krokowego}

Regulatory prądu (dla uzwojeń A i B) w przypadku silnika krokowego próbują przez cały okres pracy maszyny utrzymywać w uzwojeniach taki prąd, aby spełnione było równanie \ref{eq:stepper2}. Prąd maksymalny ($ \theta = 90\degree $) jest przemnażany przez odpowiednie współczynniki (zmienne dla danej pozycji) dla obu uzwojeń (rys. \ref{grafiki/pid_stepper.pdf}). Iloczynami są zadane prądy uzwojeń, które następnie trafiają do wspomnianych regulatorów. Poprawność działania układu potwierdza oscylogram \ref{grafiki/stepper_prady.png}.

\insertImgSetSize{grafiki/stepper_prady.png}
	{110}
	{Oscylogramy mierzonych spadków napięć na rezystorach pomiarowych w mostkach H silnika krokowego poruszającego się ze stałą zadaną prędkością kątową}
	{oprWlasne}



\clearpage